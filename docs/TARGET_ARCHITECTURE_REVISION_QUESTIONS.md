# Target Architecture: Revision Notes and Questions Linked to Published Structure

This document describes the **target** flow for revision notes and questions: they are generated **after** structure (syllabus + full extract) is published, and are linked to **published** syllabus node IDs. Everything can then be traversed recursively (top-down or bottom-up) using the same published node tree.

**Audience:** Developers and admins. Complements `docs/CURATION_SPEC.md` and `docs/CURATION_SYSTEM.md`.

**Status:** Implemented. Draft revision notes and questions are keyed by `syllabus_node_id` (published). Curation UI uses the published tree; merge scripts add node IDs to generator output before import.

---

## 1. Principle

- **Structure first:** Syllabus (structure + full extract) is curated in draft, then **published** into the canonical tree (`syllabus_nodes`, `note_blocks`). That published structure is the **source of truth** for the node tree.
- **Revision notes and questions after publish:** Revision notes and questions are **generated by scripts** that run **after** structure publish. They use **node IDs from the published structure** (`syllabus_nodes`), not from draft nodes or PDFs.
- **Single tree for everything:** All content (full extract, revision notes, questions) is linked to the same published node IDs. The app and any analytics can traverse the tree recursively (top-down or bottom-up) and reason about coverage and linkage consistently.

---

## 2. Order of Operations

1. **Curation: Structure + full extract**  
   SME edits draft structure and full-extract blocks → Save → Mark ready to publish. Admin runs publish script.  
   **Result:** `syllabus_nodes` and `note_blocks` populated for that chapter (draft → published; draft node IDs mapped to published node IDs).

2. **Generate revision notes**  
   Admin runs a **script** (e.g. after structure publish). The script:
   - Reads **published** structure for the chapter (`syllabus_nodes` for that `chapter_id`, optionally `note_blocks` or full-extract content as context).
   - Generates revision-note content per node (or per section).
   - Writes **draft** revision note blocks keyed by **`syllabus_node_id`** (published), not draft node IDs.  
   Draft tables are used so SMEs can edit before publishing revision notes.

3. **Generate questions**  
   Admin runs the **question-bank generator** script (after structure publish). The script:
   - Reads **published** structure for the chapter (`syllabus_nodes` tree + optionally published notes).
   - Generates questions per node/section according to strategy.
   - Output includes **`syllabus_node_id`** (published) per question. Import writes **draft** questions with `syllabus_node_id` set.  
   Draft tables are used so SMEs can edit and mark questions ready before publishing.

4. **SME edit drafts → publish**  
   SMEs open Revision Notes and Questions in the curation app, edit draft content, then mark ready. Admin runs publish script for revision notes and questions. Publish **copies** draft → published; node IDs are already published IDs, so **no node-ID mapping** is needed at publish time.

---

## 3. What Stays the Same

- **Full extract (note_blocks):** Unchanged. Full extract remains part of “structure” in curation: draft_syllabus_nodes + draft_note_blocks are edited together and published together to syllabus_nodes + note_blocks. This document does not change that flow.

---

## 4. Draft Content Keyed by Published Nodes

- **Draft revision note blocks** and **draft questions** are for SME editing and are published later.
- In the target model they are keyed by **published** node ID:
  - **draft_revision_note_blocks.syllabus_node_id** → `syllabus_nodes(id)`
  - **draft_questions.syllabus_node_id** → `syllabus_nodes(id)`
- So draft content is “for” a node in the **published** tree. When we publish revision notes or questions, we copy draft rows to published tables; the `syllabus_node_id` is already correct (no mapping step).

Migration adds `syllabus_node_id` (and for draft_revision_note_blocks, `chapter_id`) and drops `draft_syllabus_node_id`. Run `npm run migration:syllabus-node-id` from `backend/` after truncating draft revision blocks and draft questions (fresh start).

---

## 5. Curation App: Revision Notes and Questions Editors

- The **tree** shown in the Revision Notes and Questions editors is the **published** structure (`syllabus_nodes` for that chapter), not the draft structure.
- Draft revision note blocks and draft questions are loaded by **syllabus_node_id** (published node IDs).
- Prerequisite: **Structure must be published** for that chapter before revision notes and questions can be generated or edited. The app shows **“Publish the Structure item for this chapter first”** when there are no published nodes.
- **Orphaned:** Draft blocks/questions whose `syllabus_node_id` is no longer in the published tree (e.g. after a structure re-publish that removed nodes) are shown in an **Orphaned** section. They are not published; FK uses `ON DELETE SET NULL` so drafts are preserved.
- **Schema:** `draft_revision_note_blocks` has `chapter_id` (for listing/orphaned) and `syllabus_node_id` (nullable, `ON DELETE SET NULL`). `draft_questions` has `syllabus_node_id` (nullable, `ON DELETE SET NULL`). Published revision notes: `revision_note_blocks(syllabus_node_id, sequence_number, content_html)`.

---

## 6. Database: Single DB

- **Recommendation:** Use a **single database** containing both draft and published tables.
- **“Publish”** = the set of tables the app reads: `syllabus_nodes`, `note_blocks`, `revision_note_blocks` (if applicable), `questions`, etc.
- **“Curation”** = draft tables: `draft_syllabus_nodes`, `draft_note_blocks`, `draft_revision_note_blocks`, `draft_questions`, etc.
- Generation scripts and linkage use **published node IDs** from the same database. No cross-database sync.
- **If needed later:** Physically separate “curation DB” and “publish DB” can be considered for strict isolation or multi-tenant use; for single-team MVP, one DB is sufficient.

---

## 7. Schema Implications (Summary)

| Area | Current | Target |
|------|---------|--------|
| draft_revision_note_blocks | draft_syllabus_node_id → draft_syllabus_nodes | syllabus_node_id → syllabus_nodes |
| draft_questions | draft_syllabus_node_id → draft_syllabus_nodes | syllabus_node_id → syllabus_nodes |
| Publish script (revision notes) | Maps draft node ID → published node ID when copying | No mapping; syllabus_node_id already correct |
| Publish script (questions) | Maps draft node ID → published node ID when copying | No mapping; syllabus_node_id already correct |
| Curation API (revision notes / questions) | Returns draft tree (draft_syllabus_nodes) for that chapter | Returns **published** tree (syllabus_nodes) for that chapter for display; draft content keyed by syllabus_node_id |

---

## 8. Scripts

- **Revision notes:** Generate with `scripts/study-notes-generate` (file-based). After structure is published, run `npm run curation:merge-revision-node-ids -- <chapter_id> <path-to-study_notes_*.json>` from `backend/` to inject `syllabus_node_id` into each section (by tree order). Then run `curation:import` for revision notes.
- **Questions:** Generate with `scripts/question-bank-generate` (file-based or `--from-db`). With `--from-db`, the generator outputs **section_ref** / **section_refs** (path strings) per question; run `npm run curation:merge-questions-node-ids -- <chapter_id> <path-to-sample_questions_*.json>` from `backend/` to resolve refs to **per-question** `syllabus_node_id` (path/title match, LCA for multiple refs; unresolved → null). Without refs, the merge script falls back to item-level round-robin. Then run `curation:import` for questions; import uses **question.syllabus_node_id** when present, else **item.syllabus_node_id**.
- **Publish:** `curation:publish` copies draft_revision_note_blocks → revision_note_blocks and draft_questions → questions by syllabus_node_id (no mapping).

---

## 9. References

- `docs/CURATION_SPEC.md` – Implementation spec (per-question ready, publish behaviour).
- `docs/CURATION_SYSTEM.md` – Curation design and roles.
- `docs/ADD_NEW_CHAPTER_CURATION.md` – How to add a chapter (will be updated when this flow is implemented).
- `docs/QUESTION_BANK_GENERATION.md` – Question bank strategy and current generator.
- `backend/scripts/schema-mvp1.sql` – Current schema (draft and published tables).
- `backend/scripts/curation-publish.ts` – Publish script (structure, notes, revision_notes, questions).
- `backend/scripts/merge-revision-notes-node-ids.ts` – Injects syllabus_node_id into study_notes_*.json.
- `backend/scripts/merge-questions-node-ids.ts` – Resolves section_ref/section_refs to per-question syllabus_node_id (or item-level round-robin when no refs). See docs/QUESTION_BANK_GENERATION.md.
